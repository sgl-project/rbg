name: Build and Push Benchmark Benchtool Image

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag (e.g. latest, v0.1.0)"
        required: false
        default: "latest"

permissions:
  contents: read

jobs:
  build-push-benchmark-tool:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_SECRET }}

      - name: Set build variables
        id: vars
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building benchmark-tool image with genai-bench tag: $TAG"

      - name: Build benchmark-tool image
        env:
          TAG: ${{ steps.vars.outputs.tag }}
          IMG_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "Building benchmark-tool image with tag: $TAG"
          make docker-build-benchmark-tool-genai

      - name: Push benchmark-tool image
        env:
          TAG: ${{ steps.vars.outputs.tag }}
          IMG_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "Pushing benchmark-tool image with tag: $TAG"
          make docker-push-benchmark-tool-genai

      - name: Summary
        run: |
          echo "## Benchmark Benchtool Image Build and Push Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.vars.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Pushed" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ secrets.DOCKERHUB_USERNAME }}/rbgs-benchmark-tool-genai:${{ steps.vars.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
