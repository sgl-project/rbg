name: Nightly Docker Image Build and Push

on:
  schedule:
    # Run at 2:00 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  GO_VERSION: 1.24.1

permissions:
  contents: read

jobs:
  docker-build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_SECRET }}

      - name: Get version and tag
        id: version
        run: |
          VERSION=$(grep '^VERSION ?=' Makefile | awk '{print $3}')
          GIT_SHA=$(git rev-parse --short HEAD)
          TAG="nightly"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "git_sha=$GIT_SHA" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building version: $TAG (commit: $GIT_SHA)"

      - name: Build Docker images
        env:
          TAG: ${{ steps.version.outputs.tag }}
          IMG_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "Building images with tag: $TAG"
          make docker-build

      - name: Push Docker images
        env:
          TAG: ${{ steps.version.outputs.tag }}
          IMG_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "Pushing images with tag: $TAG"
          make docker-push

      - name: Build and push Patio image
        env:
          TAG: ${{ steps.version.outputs.tag }}
          IMG_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "Building and pushing Patio image with tag: $TAG"
          make docker-build-patio
          make docker-push-patio

      - name: Summary
        run: |
          echo "## Docker Images Build and Push Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git SHA:** ${{ steps.version.outputs.git_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Pushed" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ secrets.DOCKERHUB_USERNAME }}/rbgs-controller:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ secrets.DOCKERHUB_USERNAME }}/rbgs-upgrade-crd:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ secrets.DOCKERHUB_USERNAME }}/rbgs-patio-runtime:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
